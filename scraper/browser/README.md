# Headless Browser Module

–ú–æ–¥—É–ª—å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JavaScript-–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–∞–π—Ç–æ–≤ (SPA) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º headless-–±—Ä–∞—É–∑–µ—Ä–æ–≤.

## üìã –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–Ω–æ–≥–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ —Å–∞–π—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ HTTP-–ø–∞—Ä—Å–∏–Ω–≥–∞. –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç fallback-–º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Ç–∞–∫–∏—Ö —Å–∞–π—Ç–æ–≤.

## üéØ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–∞–π—Ç—ã

- **Meduza.io** - React-based SPA
- **TJournal.ru** - Vue.js-based SPA  
- **VC.ru** - —á–∞—Å—Ç–∏—á–Ω–æ SPA
- **DTF.ru** - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ VC.ru
- –î—Ä—É–≥–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ —Å–∞–π—Ç—ã

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Fallback

```python
# 1. –û–±—ã—á–Ω—ã–π HTTP-–∑–∞–ø—Ä–æ—Å (–±—ã—Å—Ç—Ä–æ)
html = await session.get(url)

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ SPA
if should_use_headless(html, url):
    # 3. Fallback –Ω–∞ headless (–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    html = await fetch_with_playwright(url)
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è Headless

1. **HTML —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π** (< 2KB) - –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ SPA
2. **–ò–∑–≤–µ—Å—Ç–Ω—ã–π SPA-—Å–∞–π—Ç** –∏–∑ —Å–ø–∏—Å–∫–∞ `KNOWN_SPA_DOMAINS`
3. **JavaScript-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã**: `window.__INITIAL_STATE__`, `data-react-helmet`, etc.

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –í settings.py:

```python
# –û—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
ENABLE_HEADLESS_PARSING = False

# –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:
ENABLE_HEADLESS_PARSING = True
HEADLESS_TIMEOUT = 30
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright
pip install playwright

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤
playwright install

# 3. –í–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
ENABLE_HEADLESS_PARSING = True
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
scraper/browser/
‚îú‚îÄ‚îÄ __init__.py              # –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
‚îú‚îÄ‚îÄ fallback_playwright.py   # üöß –ó–ê–ì–õ–£–®–ö–ê - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
‚îî‚îÄ‚îÄ README.md               # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üöß –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: –ó–ê–ì–õ–£–®–ö–ê

–ú–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –∑–∞–≥–ª—É—à–∫–æ–π**. –§—É–Ω–∫—Ü–∏—è `fetch_with_playwright()` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `NotImplementedError`.

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ SPA-—Å–∞–π—Ç–æ–≤
- ‚úÖ Fallback-–º–µ—Ö–∞–Ω–∏–∫–∞ –≤ BaseParser –∏ UniversalParser
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Django
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ß—Ç–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚ùå –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ Playwright
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ JavaScript-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- ‚ùå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üîÆ –ë—É–¥—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
async def fetch_with_playwright(url: str, timeout: int = 30) -> str:
    """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å Playwright."""
    from playwright.async_api import async_playwright
    
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        page = await browser.new_page()
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º User-Agent –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
        await page.set_extra_http_headers({
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
        })
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
        await page.goto(url, wait_until='networkidle')
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è SPA
        await page.wait_for_timeout(2000)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π HTML
        html = await page.content()
        await browser.close()
        
        return html
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–∑ Headless (—Ç–µ–∫—É—â–µ–µ):
- ‚ö° **–°–∫–æ—Ä–æ—Å—Ç—å**: ~1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —Å–∞–π—Ç
- üíæ **–ü–∞–º—è—Ç—å**: ~10MB –Ω–∞ –ø–∞—Ä—Å–µ—Ä  
- üéØ **–ü–æ–∫—Ä—ã—Ç–∏–µ**: 80% —Å–∞–π—Ç–æ–≤

### –° Headless (–ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ):
- üêå **–°–∫–æ—Ä–æ—Å—Ç—å**: ~10-30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–∞–π—Ç
- üíæ **–ü–∞–º—è—Ç—å**: ~100MB –Ω–∞ –±—Ä–∞—É–∑–µ—Ä
- üéØ **–ü–æ–∫—Ä—ã—Ç–∏–µ**: 90-95% —Å–∞–π—Ç–æ–≤

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### BaseParser
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –≤ fetch_url()
html = await self.fetch_url(url)  # –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å headless
```

### UniversalParser  
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –≤ fetch_page()
html = await parser.fetch_page(url)  # –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å headless
```

### Celery Tasks
```python
# –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
articles = await fetch_generic_articles(source)  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback
```

## üöÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è

–ö–æ–≥–¥–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SPA-—Å–∞–π—Ç–æ–≤:

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Playwright**: `pip install playwright`
2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä—ã**: `playwright install`  
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é** –≤ `fallback_playwright.py`
4. **–í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É**: `ENABLE_HEADLESS_PARSING = True`
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ Meduza.io –∏ TJournal.ru

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ headless:

```
INFO: –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–∑–≤–µ—Å—Ç–Ω—ã–π SPA-—Å–∞–π—Ç: https://meduza.io
INFO: –ü—ã—Ç–∞–µ–º—Å—è headless-–ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è https://meduza.io  
INFO: Headless-–ø–∞—Ä—Å–∏–Ω–≥ —É–ª—É—á—à–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 1030 ‚Üí 45231 —Å–∏–º–≤–æ–ª–æ–≤
```

---

**–°—Ç–∞—Ç—É—Å**: üöß –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üìà –°—Ä–µ–¥–Ω–∏–π (80% —Å–∞–π—Ç–æ–≤ —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ headless)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: üîß –ù–∏–∑–∫–∞—è (–∑–∞–≥–ª—É—à–∫–∞ –≥–æ—Ç–æ–≤–∞, –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é) 